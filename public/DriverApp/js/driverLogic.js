let bid;
let socket = null;
let intervalFunction = null;
let i = 0;
var html='';
var vhtml='';

var obj = [ [ 72.85085678100586, 19.138843565944068 ], [ 72.85223007202148, 19.139654429519467 ], [ 72.85343170166016, 19.140465289112228 ], [ 72.85497665405273, 19.140465289112228 ], [ 72.8561782836914, 19.141113973918838 ], [ 72.85737991333008, 19.141113973918838 ], [ 72.8584098815918, 19.140465289112228 ], [ 72.85926818847656, 19.140140945753046 ], [ 72.86029815673827, 19.139816601756635 ], [ 72.86149978637695, 19.139816601756635 ], [ 72.86218643188477, 19.139654429519467 ], [ 72.86321640014648, 19.139005738977747 ], [ 72.86424636840819, 19.139005738977747 ], [ 72.86561965942383, 19.139330084567224 ], [ 72.8668212890625, 19.139330084567224 ], [ 72.86802291870117, 19.139816601756635 ], [ 72.86888122558594, 19.139816601756635 ], [ 72.87025451660156, 19.139654429519467 ], [ 72.87094116210938, 19.139167911852134 ], [ 72.87179946899414, 19.13868139275108 ], [ 72.87248611450194, 19.13803269838618 ], [ 72.87351608276367, 19.13754617593991 ], [ 72.87351608276367, 19.136573126746544 ], [ 72.87420272827148, 19.13543789544024 ], [ 72.87437438964844, 19.134627011157416 ], [ 72.8748893737793, 19.133167409414444 ], [ 72.8748893737793, 19.132194334419058 ], [ 72.87557601928711, 19.130572530019965 ], [ 72.87660598754883, 19.12992380380149 ], [ 72.87797927856445, 19.129761621848786 ], [ 72.87918090820312, 19.129761621848786 ], [ 72.88055419921875, 19.129761621848786 ], [ 72.88244247436523, 19.129275075035242 ], [ 72.8839874267578, 19.129437257465653 ], [ 72.88518905639648, 19.129275075035242 ], [ 72.88656234741211, 19.128788526788604 ], [ 72.88793563842772, 19.128301977108908 ], [ 72.88930892944336, 19.127166688950112 ], [ 72.89033889770508, 19.126031392989653 ], [ 72.8917121887207, 19.125220462527317 ], [ 72.89291381835938, 19.124896089227946 ], [ 72.894287109375, 19.12473390233945 ], [ 72.89548873901366, 19.124571715291765 ], [ 72.8968620300293, 19.124085153193505 ], [ 72.89806365966797, 19.122949836059103 ], [ 72.89892196655273, 19.121652321211393 ], [ 72.89960861206055, 19.120516987362755 ], [ 72.89960861206055, 19.12035479617626 ], [ 72.90081024169922, 19.12035479617626 ], [ 72.90201187133789, 19.11986822166177 ], [ 72.90321350097656, 19.11954383785625 ], [ 72.90424346923828, 19.11954383785625 ], [ 72.90596008300781, 19.11986822166177 ], [ 72.90750503540039, 19.121003559967214 ], [ 72.90836334228516, 19.12230107990871 ], [ 72.90853500366211, 19.123760777665353 ], [ 72.90990829467773, 19.124247340718785 ], [ 72.9111099243164, 19.123760777665353 ], [ 72.91299819946289, 19.12392296550902 ], [ 72.91454315185547, 19.124247340718785 ], [ 72.9159164428711, 19.124571715291765 ], [ 72.9166030883789, 19.1258692072156 ], [ 72.91763305664062, 19.12635576406013 ], [ 72.91849136352539, 19.12749105779159 ], [ 72.91934967041016, 19.128626343721265 ], [ 72.92089462280273, 19.128626343721265 ], [ 72.92123794555664, 19.127166688950112 ], [ 72.92192459106445, 19.126031392989653 ], [ 72.92329788208008, 19.126031392989653 ], [ 72.92501449584961, 19.125382648938192 ], [ 72.92655944824219, 19.124896089227946 ], [ 72.92810440063477, 19.124896089227946 ], [ 72.92947769165039, 19.124896089227946 ], [ 72.93153762817383, 19.124896089227946 ], [ 72.93325424194336, 19.12473390233945 ], [ 72.93479919433594, 19.12473390233945 ], [ 72.93617248535156, 19.12473390233945 ], [ 72.93703079223633, 19.12440952808487 ], [ 72.93806076049805, 19.123760777665353 ],[ 72.85085678100586, 19.138843565944068 ], [ 72.85223007202148, 19.139654429519467 ], [ 72.85343170166016, 19.140465289112228 ], [ 72.85497665405273, 19.140465289112228 ], [ 72.8561782836914, 19.141113973918838 ], [ 72.85737991333008, 19.141113973918838 ], [ 72.8584098815918, 19.140465289112228 ], [ 72.85926818847656, 19.140140945753046 ], [ 72.86029815673827, 19.139816601756635 ], [ 72.86149978637695, 19.139816601756635 ], [ 72.86218643188477, 19.139654429519467 ], [ 72.86321640014648, 19.139005738977747 ], [ 72.86424636840819, 19.139005738977747 ], [ 72.86561965942383, 19.139330084567224 ], [ 72.8668212890625, 19.139330084567224 ], [ 72.86802291870117, 19.139816601756635 ], [ 72.86888122558594, 19.139816601756635 ], [ 72.87025451660156, 19.139654429519467 ], [ 72.87094116210938, 19.139167911852134 ], [ 72.87179946899414, 19.13868139275108 ], [ 72.87248611450194, 19.13803269838618 ], [ 72.87351608276367, 19.13754617593991 ], [ 72.87351608276367, 19.136573126746544 ], [ 72.87420272827148, 19.13543789544024 ], [ 72.87437438964844, 19.134627011157416 ], [ 72.8748893737793, 19.133167409414444 ], [ 72.8748893737793, 19.132194334419058 ], [ 72.87557601928711, 19.130572530019965 ], [ 72.87660598754883, 19.12992380380149 ], [ 72.87797927856445, 19.129761621848786 ], [ 72.87918090820312, 19.129761621848786 ], [ 72.88055419921875, 19.129761621848786 ], [ 72.88244247436523, 19.129275075035242 ], [ 72.8839874267578, 19.129437257465653 ], [ 72.88518905639648, 19.129275075035242 ], [ 72.88656234741211, 19.128788526788604 ], [ 72.88793563842772, 19.128301977108908 ], [ 72.88930892944336, 19.127166688950112 ], [ 72.89033889770508, 19.126031392989653 ], [ 72.8917121887207, 19.125220462527317 ], [ 72.89291381835938, 19.124896089227946 ], [ 72.894287109375, 19.12473390233945 ], [ 72.89548873901366, 19.124571715291765 ], [ 72.8968620300293, 19.124085153193505 ], [ 72.89806365966797, 19.122949836059103 ], [ 72.89892196655273, 19.121652321211393 ], [ 72.89960861206055, 19.120516987362755 ], [ 72.89960861206055, 19.12035479617626 ], [ 72.90081024169922, 19.12035479617626 ], [ 72.90201187133789, 19.11986822166177 ], [ 72.90321350097656, 19.11954383785625 ], [ 72.90424346923828, 19.11954383785625 ], [ 72.90596008300781, 19.11986822166177 ], [ 72.90750503540039, 19.121003559967214 ], [ 72.90836334228516, 19.12230107990871 ], [ 72.90853500366211, 19.123760777665353 ], [ 72.90990829467773, 19.124247340718785 ], [ 72.9111099243164, 19.123760777665353 ], [ 72.91299819946289, 19.12392296550902 ], [ 72.91454315185547, 19.124247340718785 ], [ 72.9159164428711, 19.124571715291765 ], [ 72.9166030883789, 19.1258692072156 ], [ 72.91763305664062, 19.12635576406013 ], [ 72.91849136352539, 19.12749105779159 ], [ 72.91934967041016, 19.128626343721265 ], [ 72.92089462280273, 19.128626343721265 ], [ 72.92123794555664, 19.127166688950112 ], [ 72.92192459106445, 19.126031392989653 ], [ 72.92329788208008, 19.126031392989653 ], [ 72.92501449584961, 19.125382648938192 ], [ 72.92655944824219, 19.124896089227946 ], [ 72.92810440063477, 19.124896089227946 ], [ 72.92947769165039, 19.124896089227946 ], [ 72.93153762817383, 19.124896089227946 ], [ 72.93325424194336, 19.12473390233945 ], [ 72.93479919433594, 19.12473390233945 ], [ 72.93617248535156, 19.12473390233945 ], [ 72.93703079223633, 19.12440952808487 ], [ 72.93806076049805, 19.123760777665353 ] ];

function sendServer() {

    const b_id = document.getElementById("BusNo").value;
    const sid = document.getElementById("ShiftNo").value;
    $.post("/UpdateConductorRouteInfo", {
        BusNo: b_id,
        Shift: sid
    }, function(data) {
        if(!data)
          alert("Enter correct credentials!!");
        else{
          bid = data;
          window.location = "driverNav.html?RouteId=" + bid;
        }
      });
}

function loadNavPage() {
  bid= parent.document.URL.substring(parent.document.URL.indexOf('=')+1, parent.document.URL.length);

  $('.nav-header').html('ROUTE ID : '+bid);
  loadcards();
  sendlocation();

}


function loadcards(){

  $.post("/getConductorDetailsUsingRoute",{route_id:bid},function(data,err){
    console.log(data[0],data[1]);
      console.log(data[0].child_ids[0]);
      console.log(data[0].child_ids.length);
      console.log(data[0].stop_name);
   for(let i=0;i<data.length;i++){
    html+=`<div class="card" id="c-${data[i].stop_name}">

    <div class="stopname">
      <h4>Stop Name : ${data[i].stop_name}</h4>
    </div>

    <div class="dynamic-container" id="${data[i].stop_name}">

      </div>



    <div class="updatestatus">

      <button id="${data[i].stop_name}" class="button0 button1" onclick="updateForNotification(this.id) ">Update</button>
    </div>

  </div>`
 vhtml="";
   for(let j=0;j<data[i].child_ids.length;j++){

    vhtml+=`<div class="container">
    <label for="checkbox-1" class="chkbox">${j+1} : ${data[i].child_names[j]}</label>
      <input class="${data[i].stop_name}" type="checkbox" value="${data[i].child_ids[j]}" >
    <hr>
  </div>`

   }
   $(".dynamic-card").append(html);
     html="";
   $("#"+data[i].stop_name).append(vhtml);
   }






  })
}



function sendlocation(){
  socket = io('http://localhost:3600');

      socket.emit('new-user', bid);
      let lat, curLat;
      let lang, curLang;
      let dif = 1;

      navigator.geolocation.getCurrentPosition((pos) => {
          // lat = curLat = pos.coords.latitude;
          // lang = curLang = pos.coords.longitude;
          lat = curLat = obj[0][1]
          lang = curLang = obj[0][0]
      });

      intervalFunction = setInterval(timer, 1000);

      function timer(){

        // curLat = pos.coords.latitude;
        // curLang = pos.coords.longitude;
        lat = curLat = obj[i++][1]
        lang = curLang = obj[i][0]

        if(i == obj.length-1){
          clearInterval(intervalFunction);
        }

        room = bid;

        let position = {
            lat: curLat,
            lang: curLang,
            room: bid
        }


        //if(abs(curLat-lat) >= 0.0001 || abs(curLang-lang) >= 0.0001 ){
          socket.emit('getloc', position);
        //   lat=curLat;
        //   lang=curLang;
        // }

    }


}

function endJourney() {
  document.getElementById("endJourney").innerHTML = "<button id='endJourney' >Journey Ended</button>";
  socket.emit('dis-user', bid);
  clearInterval(intervalFunction);
  window.location = "driverLanding.html";
}

function updateForNotification(_id) {

  //var _id = $(this).attr("id");
   let selectedlist = [];
   let notselectedlist=[];
   $.each($("input[class="+_id+"]:checked"), function(){
    selectedlist.push($(this).val());
   });
   $.each($("input[class="+_id+"]:not(:checked)"), function(){
    notselectedlist.push($(this).val());
   });
  //

   var str = "#c-"+_id;

  $(str).fadeTo(1000, 0.5).hide("slow");

  console.log(selectedlist);

   $.post('/FindAllParentsSendNotification',{rollList:selectedlist, n_rollList:notselectedlist},function(res){
   console.log(res);
   })

}
